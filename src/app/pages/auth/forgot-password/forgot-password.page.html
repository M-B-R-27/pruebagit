<!-- Header dinámico según el modo -->
<app-header 
  backButton="/auth" 
  [title]="isResetMode ? 'Restablecer Contraseña' : 'Recuperar Cuenta'">
</app-header>

<ion-content>

  <!-- ========================================== -->
  <!-- MODO 1: SOLICITAR EMAIL (modo original) -->
  <!-- ========================================== -->
  <div class="d-flex-center" *ngIf="!isResetMode && !emailSent">
    <form [formGroup]="form" class="auth-form" (ngSubmit)="submit()" (keypress.enter)="submit()">

      <app-logo></app-logo>

      <p class="ion-text-center">Te enviaremos un email para que puedas restablecer tu contraseña</p>

      <!-- Email -->
      <app-custom-input
        autocomplete="email"
        icon="mail-outline" 
        [control]="$any(form.get('email'))"
        type="email"
        label="correo">
      </app-custom-input>

      <div class="validators" *ngIf="form.controls.email.errors && form.controls.email.touched">
        <div *ngIf="form.controls.email.errors['required']">El correo es requerido</div>
        <div *ngIf="form.controls.email.errors['email']">El correo no es válido</div>
      </div>

      <ion-button 
        expand="block" 
        mode="ios" 
        class="submit" 
        type="submit" 
        [disabled]="form.invalid">
        Recuperar
        <ion-icon slot="end" name="arrow-forward"></ion-icon>
      </ion-button>

    </form>
  </div>

  <!-- ========================================== -->
  <!-- MENSAJE: EMAIL ENVIADO -->
  <!-- ========================================== -->
  <div class="d-flex-center" *ngIf="!isResetMode && emailSent">
    <div class="auth-form">
      <app-logo></app-logo>
      
      <ion-card color="success">
        <ion-card-content class="ion-text-center">
          <ion-icon name="mail" size="large"></ion-icon>
          <h2>¡Correo enviado!</h2>
          <p>Revisa tu bandeja de entrada</p>
          <p>Haz clic en el link del correo para restablecer tu contraseña</p>
        </ion-card-content>
      </ion-card>

      <ion-button 
        expand="block" 
        mode="ios" 
        routerLink="/auth">
        Volver al login
        <ion-icon slot="end" name="arrow-back"></ion-icon>
      </ion-button>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- MODO 2: RESTABLECER CONTRASEÑA (NUEVO) -->
  <!-- ========================================== -->
  <div class="d-flex-center" *ngIf="isResetMode">
    <form [formGroup]="resetForm" class="auth-form" (ngSubmit)="updatePassword()" (keypress.enter)="updatePassword()">

      <app-logo></app-logo>

      <p class="ion-text-center">Ingresa tu nueva contraseña</p>

      <!-- Nueva Contraseña -->
      <app-custom-input
        autocomplete="new-password"
        icon="lock-closed-outline" 
        [control]="$any(resetForm.get('newPassword'))"
        type="password"
        label="Nueva Contraseña">
      </app-custom-input>

      <div class="validators" *ngIf="resetForm.controls.newPassword.errors && resetForm.controls.newPassword.touched">
        <div *ngIf="resetForm.controls.newPassword.errors['required']">La contraseña es requerida</div>
        <div *ngIf="resetForm.controls.newPassword.errors['minlength']">Mínimo 6 caracteres</div>
      </div>

      <!-- Confirmar Contraseña -->
      <app-custom-input
        autocomplete="new-password"
        icon="lock-closed-outline" 
        [control]="$any(resetForm.get('confirmPassword'))"
        type="password"
        label="Confirmar Contraseña">
      </app-custom-input>

      <div class="validators" *ngIf="resetForm.controls.confirmPassword.errors && resetForm.controls.confirmPassword.touched">
        <div *ngIf="resetForm.controls.confirmPassword.errors['required']">Confirma tu contraseña</div>
        <div *ngIf="resetForm.controls.confirmPassword.errors['minlength']">Mínimo 6 caracteres</div>
      </div>

      <ion-button 
        expand="block" 
        mode="ios" 
        class="submit" 
        type="submit" 
        [disabled]="resetForm.invalid">
        Actualizar Contraseña
        <ion-icon slot="end" name="checkmark-circle-outline"></ion-icon>
      </ion-button>

    </form>
  </div>

</ion-content>